name: Build and Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} - Qt ${{ matrix.qt-version }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        qt-version: ['6.10.1']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ matrix.qt-version }}
        modules: 'qtwebsockets qthttpserver'
        cache: true

    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-dev \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-cursor0

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build Application and Tests
      run: cmake --build build --config Release

    # macOS: Create DMG
    - name: Create macOS DMG
      if: runner.os == 'macOS'
      run: |
        # Deploy Qt dependencies into the app bundle
        macdeployqt build/Fang.app -qmldir=qml

        # Install create-dmg
        brew install create-dmg

        # Create DMG
        create-dmg \
          --volname "Fang" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "Fang.app" 200 190 \
          --hide-extension "Fang.app" \
          --app-drop-link 600 185 \
          "Fang.dmg" \
          "build/Fang.app"

    # Linux: Create Flatpak
    - name: Create Linux Flatpak
      if: runner.os == 'Linux'
      run: |
        # Install flatpak and flatpak-builder
        sudo apt-get install -y flatpak flatpak-builder

        # Add Flathub repository (requires sudo for system-wide installation)
        sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

        # Install KDE runtime and SDK (requires sudo for system-wide installation)
        sudo flatpak install -y flathub org.kde.Platform//6.8 org.kde.Sdk//6.8

        # Build flatpak
        flatpak-builder --repo=repo --force-clean build-flatpak com.mrericsir.Fang.yml

        # Create bundle
        flatpak build-bundle repo Fang.flatpak com.mrericsir.Fang

    # Windows: Create MSI
    - name: Create Windows MSI
      if: runner.os == 'Windows'
      run: |
        # Deploy Qt dependencies
        windeployqt build/Release/Fang.exe --qmldir qml

        # Install WiX Toolset
        dotnet tool install --global wix

        # Add WiX extensions
        wix extension add WixToolset.Heat.Extension
        wix extension add WixToolset.UI.wixext

        # Set APP_VERSION environment variable
        $env:APP_VERSION = "0.2.0"

        # Generate file list with heat (-scom suppresses COM/SelfReg warnings for Qt plugins)
        wix extension list
        heat dir build/Release -cg FangFilesGroup -gg -sfrag -srd -scom -dr FangPath -out build/files.wxs

        # Build MSI
        wix build fang.wxs build/files.wxs -out build/Fang.msi -ext WixToolset.UI.wixext

    - name: Upload DMG Installer (macOS)
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: Fang-macOS-DMG
        path: Fang.dmg

    - name: Upload Flatpak Bundle (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: Fang-Linux-Flatpak
        path: Fang.flatpak

    - name: Upload MSI Installer (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: Fang-Windows-MSI
        path: build/Fang.msi

    - name: Run tests
      run: ctest --test-dir build --output-on-failure --build-config Release
      env:
        QT_QPA_PLATFORM: offscreen  # For Linux headless testing

    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}
        path: build/Testing/Temporary/
