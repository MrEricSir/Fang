name: Unit Tests

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    name: ${{ matrix.os }} - Qt ${{ matrix.qt-version }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        qt-version: ['6.7.0']  # Qt 6.10 may not be available yet in aqtinstall

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ matrix.qt-version }}
        modules: 'qtwebsockets qthttpserver'
        cache: true

    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-dev \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-cursor0

    # Configure full project but only build test targets
    # (Main app requires Qt 6.10+, tests work with Qt 6.7+)
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build Tests Only
      run: |
        cmake --build build --config Release --target tst_fangparser
        cmake --build build --config Release --target tst_testfangfavicongrabbertest
        cmake --build build --config Release --target tst_testfangfeeddiscovery
        cmake --build build --config Release --target tst_testfangsimplestatemachine
        cmake --build build --config Release --target tst_testrawfeedrewritertest
        cmake --build build --config Release --target tst_urlfixup
        cmake --build build --config Release --target tst_testwebpagegrabber

    - name: Run tests
      run: ctest --test-dir build --output-on-failure --build-config Release
      env:
        QT_QPA_PLATFORM: offscreen  # For Linux headless testing

    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}
        path: build/Testing/Temporary/
